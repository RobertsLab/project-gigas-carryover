---
title: "01.01-qPCR"
author: "Sam White"
date: "2024-03-27"
output: 
  github_document:
    toc: true
    number_sections: true
  bookdown::html_document2:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
    code_download: true
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
    code_download: true
link-citations: true
---

```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
library(ggplot2)

knitr::opts_chunk$set(
  echo = TRUE,         # Display code chunks
  eval = TRUE,        # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  comment = ""         # Prevents appending '##' to beginning of lines in code output
)

# Get the current working directory
current_dir <- getwd()

# Check if the script is being knitted
if (basename(current_dir) == "scripts") {
  # If knitting, set the path relative to the script directory
  cqs_directory <- "../data/qPCR/Cq"
} else {
  # If running interactively, set the path relative to the project directory
  cqs_directory <- "lifestage_carryover/data/qPCR/Cq"
}
```


# Set variables

## Set sample groups

Groups are named in the following fashion:

`<life.stage>.<conditioning.treatment>.<acute.treatment>`

This allows for parsing downstream.
```{r set-sample-groups, eval=TRUE}

seed.control.ambient=c("29", "40", "55", "63", "69", "101", "119", "122", "155", "164", "187", "202", "209", "214", "233", "236", "275")
seed.control.high=c("42", "59", "60", "62", "86", "102", "140", "176", "177", "184", "192", "223", "234", "243", "244", "254", "264")
seed.treated.ambient=c("14", "48", "66", "72", "89", "115", "129", "138", "156", "182", "191", "201", "227", "239", "270", "277", "280")
seed.treated.high=c("15", "19", "24", "88", "92", "105", "111", "113", "120", "128", "161", "200", "211", "256", "257", "266", "285")
spat.control.ambient=c("11", "30", "36", "52", "77", "114", "134", "142", "144", "183", "193", "229", "230", "231", "240", "272", "287")
spat.control.high=c("27", "74", "93", "96", "97", "137", "143", "153", "168", "178", "189", "206", "262", "274", "282", "284", "289")
spat.treated.ambient=c("9", "13", "38", "46", "47", "121", "145", "151", "174", "194", "197", "198", "216", "235", "241", "252", "291")
spat.treated.high=c("6", "25", "50", "78", "124", "126", "131", "160", "163", "172", "220", "226", "242", "253", "296", "298")
juvenile.control.ambient=c("18", "57", "65", "75", "79", "104", "110", "123", "125", "171", "175", "205", "238", "273", "279", "293", "317")
juvenile.control.high=c("12", "39", "43", "49", "71", "130", "141", "146", "150", "170", "195", "297", "301", "324", "351", "355", "371")
juvenile.treated.ambient=c("1", "34", "64", "83", "98", "147", "152", "158", "162", "169", "188", "271", "295", "310", "357", "361", "381")
juvenile.treated.high=c("28", "53", "61", "73", "81", "106", "109", "139", "149", "173", "181", "213", "290", "302", "311", "364", "392")
adult.control.ambient=c("3", "5", "13*", "16", "17", "80", "87", "94", "148", "159", "179", "180", "250", "258", "268", "312", "326", "330", "334", "346", "360", "377", "379", "386")
adult.control.high=c("20", "23", "26", "32", "33", "67", "70", "90", "107", "132", "135", "157", "166", "186", "207", "215", "248", "316", "341", "344", "349", "382", "394", "395")
adult.treated.ambient=c("7", "31", "35", "37", "41", "54", "84", "100", "112", "116", "118", "133", "154", "199", "203", "204", "208", "219", "294", "318", "339", "353", "363", "378")
adult.treated.high=c("21", "22", "45", "82", "85", "91", "95", "99", "103", "108", "117", "127", "165", "185", "190", "196", "232", "237", "245", "263", "276", "306", "343", "374")

```

```{r assign-groups-to-list, eval=TRUE}
# Combine vectors into lists
# Used for adding treatment info and/or subsetting downstream

groups_list <- list(juvenile.control.ambient = juvenile.control.ambient,
                                   juvenile.control.high = juvenile.control.high,
                                   juvenile.treated.ambient = juvenile.treated.ambient,
                                   juvenile.treated.high = juvenile.treated.high,
                                   adult.control.ambient = adult.control.ambient,
                                   adult.control.high = adult.control.high,
                                   adult.treated.ambient = adult.treated.ambient,
                                   adult.treated.high = adult.treated.high,
                                   seed.control.ambient = seed.control.ambient,
                                   seed.control.high = seed.control.high,
                                   seed.treated.ambient = seed.treated.ambient,
                                   seed.treated.high = seed.treated.high,
                                   spat.control.ambient = spat.control.ambient,
                                   spat.control.high = spat.control.high,
                                   spat.treated.ambient = spat.treated.ambient,
                                   spat.treated.high = spat.treated.high)
```

# Functions

## Calculate delta Cq

Normalized to designated normalizing gene
```{r function-delta-Cq, eval=TRUE}
calculate_delta_Cq <- function(df) {
  df <- df %>%
    group_by(Sample) %>%
    mutate(delta_Cq = Cq.Mean - Cq.Mean[Target == "GAPDH"]) %>%
    ungroup()
  
  return(df)
}
```

## Create delta Cq boxplots

### Lifestage comparison
```{r function-boxplots-delta-Cq, eval=TRUE}
# Function to create box plots for each comparison
create_boxplot_delta_Cq <- function(data, comparison, t_test_results) {
  # Extract life stages from comparison
  life_stages <- unlist(strsplit(comparison, "\\."))

  # Debugging: Print life stages
  # print(paste("Life stages for comparison:", comparison))
  # print(life_stages)

  # Filter data for the relevant life stages
  filtered_data <- data %>%
    filter(life.stage %in% life_stages)

  # Debugging: Print filtered data
  # print("Filtered data:")
  # print(filtered_data)

  # Check if both life stages are included
  if (!all(life_stages %in% unique(filtered_data$life.stage))) {
    stop("Not all life stages are included in the filtered data")
  }

  y_limits <- range(filtered_data$delta_Cq, na.rm = TRUE)

  # Debugging: Print y_limits
  # print("Y limits:")
  # print(y_limits)

  # Filter t_test_results for the current comparison
  t_test_results_filtered <- t_test_results %>%
    filter(comparison == !!comparison)

  # Debugging: Print filtered t_test_results
  # print("Filtered t_test_results:")
  # print(t_test_results_filtered)

  # Filter t_test_results for asterisks
  t_test_results_with_asterisks <- t_test_results_filtered %>%
    filter(asterisk != "")

  # Debugging: Print t_test_results_with_asterisks
  # print("t_test_results_with_asterisks:")
  # print(t_test_results_with_asterisks)

  formatted_title <- paste0(toupper(substring(life_stages[1], 1, 1)), substring(life_stages[1], 2), 
                            " vs. ", 
                            toupper(substring(life_stages[2], 1, 1)), substring(life_stages[2], 2))

  boxplot <- ggplot(filtered_data, aes(x = Target, y = delta_Cq, fill = life.stage)) +
    geom_boxplot(position = position_dodge(width = 0.75)) +
    theme_minimal() +
    theme(legend.position = "right") +
    scale_fill_manual(values=c("darkgray", "salmon", "lightblue", "lightgreen")) +
    ylim(y_limits) +
    labs(x = "Target", y = "Delta Cq", title = formatted_title) +
    # Highlighted section: Adds asterisks
    geom_text(data = t_test_results_with_asterisks, 
              aes(x = Target, y = y_limits[2] - 1, label = asterisk), 
              vjust = -0.5, size = 8, color = "black", inherit.aes = FALSE)

  print(boxplot)
}
```

### Conditioning comparisons

1. Extract Life Stage and Conditioning Treatments:

- The comparison string is split into its components (`life_stage`, `treatment1`, and `treatment2`).

2. Filter Data:

- The filtered_data data frame is filtered to include only the rows with the relevant life stage and conditioning treatments.

3. Check for Both Treatments:

- Ensure that both treatments are included in the `filtered_data`.

4. Filter T-Test Results:

- The `t_test_results_filtered` data frame is filtered for the specific comparison.

- The `t_test_results_with_asterisks` data frame is created to include only the rows with asterisks.

5. Format the Title:

- The `formatted_title` variable is created by capitalizing the first letter of each component and concatenating them with " - " and " vs. " in between.

- This should create box plots comparing conditioning treatments within each life stage, with titles formatted as `<life.stage> - Treated vs. Control`.

```{r function-boxplots-delta-Cq-conditioning-treatments, eval=TRUE}
# Function to create box plots for each comparison of conditioning treatments within life stages
create_boxplot_conditioning <- function(data, comparison, t_test_results) {
  # Extract life stage and conditioning treatments from comparison
  comparison_parts <- unlist(strsplit(comparison, "\\."))
  life_stage <- comparison_parts[1]
  treatment1 <- comparison_parts[2]
  treatment2 <- comparison_parts[3]

  # Debugging: Print life stage and treatments
  # print(paste("Life stage and treatments for comparison:", comparison))
  # print(c(life_stage, treatment1, treatment2))

  # Filter data for the relevant life stage and conditioning treatments
  filtered_data <- data %>%
    filter(life.stage == life_stage, conditioning.treatment %in% c(treatment1, treatment2))

  # Debugging: Print filtered data
  # print("Filtered data:")
  # print(filtered_data)

  # Check if both treatments are included
  if (!all(c(treatment1, treatment2) %in% unique(filtered_data$conditioning.treatment))) {
    stop("Not all treatments are included in the filtered data")
  }

  y_limits <- range(filtered_data$delta_Cq, na.rm = TRUE)

  # Debugging: Print y_limits
  # print("Y limits:")
  # print(y_limits)

  # Filter t_test_results for the current comparison
  t_test_results_filtered <- t_test_results %>%
    filter(comparison == !!comparison)

  # Debugging: Print filtered t_test_results
  # print("Filtered t_test_results:")
  # print(t_test_results_filtered)

  # Filter t_test_results for asterisks
  t_test_results_with_asterisks <- t_test_results_filtered %>%
    filter(asterisk != "")

  # Debugging: Print t_test_results_with_asterisks
  # print("t_test_results_with_asterisks:")
  # print(t_test_results_with_asterisks)

  # Format the title
  formatted_title <- paste0(toupper(substring(life_stage, 1, 1)), substring(life_stage, 2), 
                            " - ", 
                            toupper(substring(treatment1, 1, 1)), substring(treatment1, 2), 
                            " vs. ", 
                            toupper(substring(treatment2, 1, 1)), substring(treatment2, 2))

  boxplot <- ggplot(filtered_data, aes(x = Target, y = delta_Cq, fill = conditioning.treatment)) +
    geom_boxplot(position = position_dodge(width = 0.75)) +
    theme_minimal() +
    theme(legend.position = "right") +
    scale_fill_manual(values=c("darkgray", "salmon")) +
    ylim(y_limits) +
    labs(x = "Target", y = "Delta Cq", title = formatted_title) +
    # Highlighted section: Adds asterisks
    geom_text(data = t_test_results_with_asterisks, 
              aes(x = Target, y = y_limits[2] - 1, label = asterisk), 
              vjust = -0.5, size = 8, color = "black", inherit.aes = FALSE)

  print(boxplot)
}
```

### Acute comparisons

1. Extract Life Stage and Acute Treatments:

- The comparison string is split into its components (`life_stage`, `treatment1`, and `treatment2`).

2. Filter Data:

- The `filtered_data` data frame is filtered to include only the rows with the relevant life stage and acute treatments.

3. Check for Both Treatments:

- Ensure that both treatments are included in the `filtered_data`.

4. Filter T-Test Results:

- The `t_test_results_filtered` data frame is filtered for the specific comparison.

- The `t_test_results_with_asterisks` data frame is created to include only the rows with asterisks.
Format the Title:

5. The formatted_title variable is created by capitalizing the first letter of each component and concatenating them with " - " and " vs. " in between.
- This should create box plots comparing acute treatments within each life stage, with titles formatted as `<life.stage> - Ambient vs. High`.
```{r function-boxplots-delta-Cq-treatments, eval=TRUE}

# Function to create box plots for each comparison of acute treatments within life stages
create_boxplot_acute <- function(data, comparison, t_test_results) {
  # Extract life stage and acute treatments from comparison
  comparison_parts <- unlist(strsplit(comparison, "\\."))
  life_stage <- comparison_parts[1]
  treatment1 <- comparison_parts[2]
  treatment2 <- comparison_parts[3]

  # Debugging: Print life stage and treatments
  # print(paste("Life stage and treatments for comparison:", comparison))
  # print(c(life_stage, treatment1, treatment2))

  # Filter data for the relevant life stage and acute treatments
  filtered_data <- data %>%
    filter(life.stage == life_stage, acute.treatment %in% c(treatment1, treatment2))

  # Debugging: Print filtered data
  # print("Filtered data:")
  # print(filtered_data)

  # Check if both treatments are included
  if (!all(c(treatment1, treatment2) %in% unique(filtered_data$acute.treatment))) {
    stop("Not all treatments are included in the filtered data")
  }

  y_limits <- range(filtered_data$delta_Cq, na.rm = TRUE)

  # Debugging: Print y_limits
  # print("Y limits:")
  # print(y_limits)

  # Filter t_test_results for the current comparison
  t_test_results_filtered <- t_test_results %>%
    filter(comparison == !!comparison)

  # Debugging: Print filtered t_test_results
  # print("Filtered t_test_results:")
  # print(t_test_results_filtered)

  # Filter t_test_results for asterisks
  t_test_results_with_asterisks <- t_test_results_filtered %>%
    filter(asterisk != "")

  # Debugging: Print t_test_results_with_asterisks
  # print("t_test_results_with_asterisks:")
  # print(t_test_results_with_asterisks)

  # Format the title
  formatted_title <- paste0(toupper(substring(life_stage, 1, 1)), substring(life_stage, 2), 
                            " - ", 
                            toupper(substring(treatment1, 1, 1)), substring(treatment1, 2), 
                            " vs. ", 
                            toupper(substring(treatment2, 1, 1)), substring(treatment2, 2))

  boxplot <- ggplot(filtered_data, aes(x = Target, y = delta_Cq, fill = acute.treatment)) +
    geom_boxplot(position = position_dodge(width = 0.75)) +
    theme_minimal() +
    theme(legend.position = "right") +
    scale_fill_manual(values=c("darkgray", "salmon")) +
    ylim(y_limits) +
    labs(x = "Target", y = "Delta Cq", title = formatted_title) +
    # Highlighted section: Adds asterisks
    geom_text(data = t_test_results_with_asterisks, 
              aes(x = Target, y = y_limits[2] - 1, label = asterisk), 
              vjust = -0.5, size = 8, color = "magenta", inherit.aes = FALSE)

  print(boxplot)
}
```

### Acute treatements within life stage conditioning
```{r function-boxplots-delta-Cq-acute-treatments-within-lifestage-conditioning, eval=TRUE}
# Function to create box plots for each comparison of acute treatments within life stages and conditioning treatments
create_boxplot_acute_conditioning <- function(data, comparison, t_test_results) {
  # Extract life stage, conditioning treatment, and acute treatments from comparison
  comparison_parts <- unlist(strsplit(comparison, "\\."))
  life_stage <- comparison_parts[1]
  conditioning_treatment <- comparison_parts[2]
  treatment1 <- comparison_parts[3]
  treatment2 <- comparison_parts[5]

  # Filter data for the relevant life stage, conditioning treatment, and acute treatments
  filtered_data <- data %>%
    filter(life.stage == life_stage, conditioning.treatment == conditioning_treatment, acute.treatment %in% c(treatment1, treatment2))

  # Check if both treatments are included
  if (!all(c(treatment1, treatment2) %in% unique(filtered_data$acute.treatment))) {
    stop("Not all treatments are included in the filtered data")
  }

  y_limits <- range(filtered_data$delta_Cq, na.rm = TRUE)

  # Filter t_test_results for the current comparison
  t_test_results_filtered <- t_test_results %>%
    filter(comparison == !!comparison)

  # Filter t_test_results for asterisks
  t_test_results_with_asterisks <- t_test_results_filtered %>%
    filter(asterisk != "")

  # Format the title
  formatted_title <- paste0(toupper(substring(life_stage, 1, 1)), substring(life_stage, 2), 
                            " - ", 
                            toupper(substring(conditioning_treatment, 1, 1)), substring(conditioning_treatment, 2), 
                            " - ", 
                            toupper(substring(treatment1, 1, 1)), substring(treatment1, 2), 
                            " vs. ", 
                            toupper(substring(treatment2, 1, 1)), substring(treatment2, 2))

  boxplot <- ggplot(filtered_data, aes(x = Target, y = delta_Cq, fill = acute.treatment)) +
    geom_boxplot(position = position_dodge(width = 0.75)) +
    theme_minimal() +
    theme(legend.position = "right") +
    scale_fill_manual(values=c("darkgray", "salmon")) +
    ylim(y_limits) +
    labs(x = "Target", y = "Delta Cq", title = formatted_title) +
    # Adds asterisks
    geom_text(data = t_test_results_with_asterisks, 
              aes(x = Target, y = y_limits[2] - 1, label = asterisk), 
              vjust = -0.5, size = 8, color = "black", inherit.aes = FALSE)

  print(boxplot)
}
```

# Read in files
```{r read-in-Cq-files, eval=TRUE}

# Get a list of all CSV files in the directory with the naming structure "*Cq-Results.csv"
cq_file_list <- list() # Initialize list
cq_file_list <- list.files(path = cqs_directory, pattern = "Cq-Results\\.csv$", full.names = TRUE)

# Initialize an empty list to store the data frames
data_frames_list <- list()

# Loop through each file and read it into a data frame, then add it to the list
for (file in cq_file_list) {
  data <- read.csv(file, header = TRUE)
  data$Sample <- as.character(data$Sample)  # Convert Sample column to character type
  data_frames_list[[file]] <- data
}

# Combine all data frames into a single data frame
combined_df <- bind_rows(data_frames_list, .id = "data_frame_id")

str(combined_df)

```

# Clean data


## Replace target names
```{r replace-target-names, eval=TRUE}
# Remove rows with Sample name "NTC"
combined_df <- combined_df[combined_df$Sample != "NTC", ]


# Replace values in the Target column
combined_df$Target <- gsub("Cg_GAPDH_205_F-355_R \\(SR IDs: 1172/3\\)", "GAPDH", combined_df$Target)

combined_df$Target <- gsub("Cg_ATPsynthase_F/R \\(SR IDs: 1385/6\\)", "ATPsynthase", combined_df$Target)

combined_df$Target <- gsub("Cg_cGAS \\(SR IDs: 1826/7\\)", "cGAS", combined_df$Target)

combined_df$Target <- gsub("Cg_citrate_synthase \\(SR IDs: 1383/4\\)", "citrate.sythase", combined_df$Target)

combined_df$Target <- gsub("Cg_DNMT1_F \\(SR IDs: 1510/1\\)", "DNMT1", combined_df$Target)

combined_df$Target <- gsub("Cg_HSP70_F/R \\(SR IDs: 598/9\\)", "HSP70", combined_df$Target)

combined_df$Target <- gsub("Cg_Hsp90_F/R \\(SR IDs: 1532/3\\)", "HSP90", combined_df$Target)

combined_df$Target <- gsub("Cg_VIPERIN_F/R \\(SR IDs: 1828/9\\)", "VIPERIN", combined_df$Target)

str(combined_df)
```



## Identify Samples with Cq.Std..Dev > 0.5
```{r high-cq-std-dev, eval=TRUE}
# Filter out rows where Cq.Std..Dev is NA
combined_df <- combined_df[!is.na(combined_df$Cq.Std..Dev), ]

# Filter rows where Cq.Std..Dev is greater than 0.5
high_cq_std_dev <- combined_df[combined_df$Cq.Std..Dev > 0.5, ]

# Print the filtered rows with specified columns, without row names
print(high_cq_std_dev[, c("Target", "Sample", "Cq", "Cq.Std..Dev")], row.names = FALSE)
```

## Remove bad technical reps
```{r adult-juv-remove-bad-technical-reps, eval=TRUE}
# Group by Sample and Target, then filter out the outlier replicate
combined.fitered_df<- combined_df %>%
  group_by(Sample, Target) %>%
  filter(abs(Cq - mean(Cq, na.rm = TRUE)) <= Cq.Std..Dev)

# Print the filtered data frame
str(combined.fitered_df)
```



# Group samples by target
```{r samples-by-target, eval=TRUE}
# Group by Sample and Target, then summarize to get unique rows for each sample
grouped_df <- combined.fitered_df%>%
  group_by(Sample, Target) %>%
  summarize(Cq.Mean = mean(Cq, na.rm = TRUE)) %>%
  ungroup()

str(grouped_df)
```

# Add life stage and treatment cols
```{r add-columns, eval=TRUE}
# Initialize new columns
grouped_df <- grouped_df %>%
  mutate(life.stage = NA_character_,
         conditioning.treatment = NA_character_,
         acute.treatment = NA_character_)

# Loop through each vector
for (vec_name in names(groups_list)) {
  vec <- groups_list[[vec_name]]
  stage <- strsplit(vec_name, "\\.")[[1]][1]
  conditioning_treatment <- strsplit(vec_name, "\\.")[[1]][2]
  acute_treatment <- strsplit(vec_name, "\\.")[[1]][3]
  
  # Loop through each row in grouped_df
  for (i in 1:nrow(grouped_df)) {
    sample <- grouped_df$Sample[i]
    
    # Check if sample is in the vector
    if (sample %in% vec) {
      # Update life.stage and treatment columns
      grouped_df$life.stage[i] <- stage
      grouped_df$conditioning.treatment[i] <- conditioning_treatment
      grouped_df$acute.treatment[i] <-acute_treatment
    }
  }
}

str(grouped_df)

```

# Delta Cq to Normalizing Gene
```{r delta-Cq, eval=TRUE}
# Calculate delta Cq by subtracting GAPDH Cq.Mean from each corresponding Sample Cq.Mean
delta_Cq_df <- calculate_delta_Cq(grouped_df)

# Filters out normalizing gene, since no need to compare normalizing gene to itself.
delta_Cq_df <- delta_Cq_df %>%
  filter(!is.na(life.stage), !is.na(Target), Target != "GAPDH")

str(delta_Cq_df)
```

## t-tests

### Life Stages

This code does the following:

1. Extracts the unique life.stage levels from the data frame.
2. Generates all possible pairs of life.stage levels using the combn function.
3. Iterates over each pair and performs the t-test for each Target. Adds an
asterisk column and an asterisk if the p-value is <= 0.05. Useful for downstream
parsing.
4. Stores the results in a list and combines them into a single data frame.
5. Adds a comparison column to indicate which life.stage levels were compared.

```{r life-stage-t-tests, eval=TRUE}
# Extract unique life.stage levels
unique_life_stages <- unique(delta_Cq_df$life.stage)

# Generate all possible pairs of life.stage levels
life_stage_pairs <- combn(unique_life_stages, 2, simplify = FALSE)

# Initialize a list to store results
life_stage_t_test_results_list <- list()

for (pair in life_stage_pairs) {
  stage1 <- pair[1]
  stage2 <- pair[2]
  
  # Perform t-test for each Target comparing the two life.stage levels
  t_test_results <- delta_Cq_df %>%
    filter(life.stage %in% c(stage1, stage2)) %>%
    group_by(Target) %>%
    summarise(
      t_test_result = list(t.test(delta_Cq ~ life.stage))
    ) %>%
    ungroup() %>%
    mutate(
      estimate_diff = sapply(t_test_result, function(x) x$estimate[1] - x$estimate[2]),
      p_value = sapply(t_test_result, function(x) x$p.value),
      asterisk = ifelse(p_value <= 0.05, "*", ""), # Adds asterisk column and asterisk for p-value.
      comparison = paste(stage1, "vs", stage2, sep = ".")
    ) %>%
    select(!t_test_result)
  
  life_stage_t_test_results_list[[paste(stage1, stage2, sep = ".")]] <- t_test_results
}

# Combine results into a single data frame
life_stage_t_test_results_df <- bind_rows(life_stage_t_test_results_list, .id = "comparison")

# View the results
print(life_stage_t_test_results_df)
```

### Conditioning treatments

This code does the following:

1. Extracts the unique life.stage levels from the data frame.
2. For each life.stage, extracts the unique conditioning.treatment levels.
3. Generates all possible pairs of conditioning.treatment levels within each life.stage.
4. Iterates over each pair and performs the t-test for each Target. Adds an
asterisk column and an asterisk if the p-value is <= 0.05. Useful for downstream
parsing.
5. Stores the results in a list and combines them into a single data frame.
6. Adds a comparison column to indicate which life.stage and conditioning.treatment levels were compared.

```{r conditioning-treatments-life-stages, eval=TRUE}
# Extract unique life.stage levels
unique_life_stages <- unique(delta_Cq_df$life.stage)

# Initialize a list to store results
conditioning_treatment_t_test_results_list <- list()

for (stage in unique_life_stages) {
  # Extract unique conditioning.treatment levels within the current life.stage
  unique_treatments <- unique(delta_Cq_df %>% filter(life.stage == stage) %>% pull(conditioning.treatment))
  
  # Generate all possible pairs of conditioning.treatment levels
  treatment_pairs <- combn(unique_treatments, 2, simplify = FALSE)
  
  for (pair in treatment_pairs) {
    treatment1 <- pair[1]
    treatment2 <- pair[2]
    
    # Perform t-test for each Target comparing the two conditioning.treatment levels within the current life.stage
    t_test_results <- delta_Cq_df %>%
      filter(life.stage == stage, conditioning.treatment %in% c(treatment1, treatment2)) %>%
      group_by(Target) %>%
      summarise(
        t_test_result = list(t.test(delta_Cq ~ conditioning.treatment))
      ) %>%
      ungroup() %>%
      mutate(
        estimate_diff = sapply(t_test_result, function(x) x$estimate[1] - x$estimate[2]),
        p_value = sapply(t_test_result, function(x) x$p.value),
        asterisk = ifelse(p_value <= 0.05, "*", ""), # Adds asterisk column and asterisk for p-value.
        comparison = paste(stage, treatment1, "vs", treatment2, sep = ".")
      ) %>%
      select(!t_test_result)
    
    conditioning_treatment_t_test_results_list[[paste(stage, treatment1, treatment2, sep = ".")]] <- t_test_results
  }
}

# Combine results into a single data frame
conditioning_treatment_t_test_results_df <- bind_rows(conditioning_treatment_t_test_results_list, .id = "comparison")

# View the results
print(conditioning_treatment_t_test_results_df)
```


### Acute treatments

This code does the following:

1. Extracts the unique life.stage levels from the data frame.
2. For each life.stage, extracts the unique acute.treatment levels.
3. Generates all possible pairs of acute.treatment levels within each life.stage.
4. Iterates over each pair and performs the t-test for each Target. Adds an
asterisk column and an asterisk if the p-value is <= 0.05. Useful for downstream
parsing.
5. Stores the results in a list and combines them into a single data frame.
6. Adds a comparison column to indicate which life.stage and acute.treatment levels were compared.

Excludes `seed` and `spat`, as these were only held at `ambient` for the acute treatment.
```{r acute-treatments-life-stages, eval=TRUE}
# Extract unique life.stage levels, excluding 'seed' and 'spat'
unique_life_stages <- unique(delta_Cq_df$life.stage)
unique_life_stages <- setdiff(unique_life_stages, c("seed", "spat"))

# Initialize a list to store results
acute_treatment_t_test_results_list <- list()

for (stage in unique_life_stages) {
  # Extract unique acute.treatment levels within the current life.stage
  unique_treatments <- unique(delta_Cq_df %>% filter(life.stage == stage) %>% pull(acute.treatment))
  
  # Check if there are at least 2 unique treatments
  if (length(unique_treatments) >= 2) {
    # Generate all possible pairs of acute.treatment levels
    treatment_pairs <- combn(unique_treatments, 2, simplify = FALSE)
    
    for (pair in treatment_pairs) {
      treatment1 <- pair[1]
      treatment2 <- pair[2]
      
      # Perform t-test for each Target comparing the two acute.treatment levels within the current life.stage
      t_test_results <- delta_Cq_df %>%
        filter(life.stage == stage, acute.treatment %in% c(treatment1, treatment2)) %>%
        group_by(Target) %>%
        summarise(
          t_test_result = list(t.test(delta_Cq ~ acute.treatment))
        ) %>%
        ungroup() %>%
        mutate(
          estimate_diff = sapply(t_test_result, function(x) x$estimate[1] - x$estimate[2]),
          p_value = sapply(t_test_result, function(x) x$p.value),
          asterisk = ifelse(p_value <= 0.05, "*", ""), # Adds asterisk column and asterisk for p-value.
          comparison = paste(stage, treatment1, "vs", treatment2, sep = ".")
        ) %>%
        select(!t_test_result)
      
      acute_treatment_t_test_results_list[[paste(stage, treatment1, treatment2, sep = ".")]] <- t_test_results
    }
  }
}

# Combine results into a single data frame
acute_treatment_t_test_results_df <- bind_rows(acute_treatment_t_test_results_list, .id = "comparison")

# View the results
print(acute_treatment_t_test_results_df)

```

### Acute within life stage and conditioning
```{r acute-treatments-within-life-stages-conditioning, eval=TRUE}
# Extract unique life.stage levels, excluding 'seed' and 'spat'
unique_life_stages <- unique(delta_Cq_df$life.stage)
unique_life_stages <- setdiff(unique_life_stages, c("seed", "spat"))

# Extract unique conditioning.treatment levels
unique_conditioning_treatments <- unique(delta_Cq_df$conditioning.treatment)

# Initialize a list to store results
acute_treatment_within_life.stages_conditioning_t_test_results_list <- list()

for (stage in unique_life_stages) {
  for (conditioning in unique_conditioning_treatments) {
    # Extract unique acute.treatment levels within the current life.stage and conditioning.treatment
    unique_treatments <- unique(delta_Cq_df %>% filter(life.stage == stage, conditioning.treatment == conditioning) %>% pull(acute.treatment))
    
    # Check if there are at least 2 unique treatments
    if (length(unique_treatments) >= 2) {
      # Generate all possible pairs of acute.treatment levels
      treatment_pairs <- combn(unique_treatments, 2, simplify = FALSE)
      
      for (pair in treatment_pairs) {
        treatment1 <- pair[1]
        treatment2 <- pair[2]
        
        # Perform t-test for each Target comparing the two acute.treatment levels within the current life.stage and conditioning.treatment
        t_test_results <- delta_Cq_df %>%
          filter(life.stage == stage, conditioning.treatment == conditioning, acute.treatment %in% c(treatment1, treatment2)) %>%
          group_by(Target) %>%
          summarise(
            t_test_result = list(t.test(delta_Cq ~ acute.treatment))
          ) %>%
          ungroup() %>%
          mutate(
            estimate_diff = sapply(t_test_result, function(x) x$estimate[1] - x$estimate[2]),
            p_value = sapply(t_test_result, function(x) x$p.value),
            asterisk = ifelse(p_value <= 0.05, "*", ""), # Adds asterisk column and asterisk for p-value.
            comparison = paste(stage, conditioning, treatment1, "vs", treatment2, sep = ".")
          ) %>%
          select(!t_test_result)
        
        acute_treatment_within_life.stages_conditioning_t_test_results_list[[paste(stage, conditioning, treatment1, treatment2, sep = ".")]] <- t_test_results
      }
    }
  }
}

# Combine results into a single data frame
acute_treatment_within_life.stages_conditioning_t_test_results_df <- bind_rows(acute_treatment_within_life.stages_conditioning_t_test_results_list, .id = "comparison_id")

# View the results
print(acute_treatment_within_life.stages_conditioning_t_test_results_df)
```

## Plotting

### Delta Cq boxplots

#### Lifestage comparisons
```{r delta-Cq-boxplots-lifestage, eval=TRUE}
# Create box plots for each comparison
unique_comparisons <- unique(life_stage_t_test_results_df$comparison)

for (comparison in unique_comparisons) {
  create_boxplot_delta_Cq(delta_Cq_df, comparison, life_stage_t_test_results_df)
}
```

### Conditioning comparisons
```{r delta-Cq-boxplots-conditioning, eval=TRUE}

# Create box plots for each comparison
unique_comparisons <- unique(conditioning_treatment_t_test_results_df$comparison)

for (comparison in unique_comparisons) {
  create_boxplot_conditioning(delta_Cq_df, comparison, conditioning_treatment_t_test_results_df)
}
```

### Acute treatment comparisons
```{r delta-Cq-boxplots-acute-treatment, eval=TRUE}
# Create box plots for each comparison
unique_comparisons <- unique(acute_treatment_t_test_results_df$comparison)

for (comparison in unique_comparisons) {
  create_boxplot_acute(delta_Cq_df, comparison, acute_treatment_t_test_results_df)
}
```

### Acute within life stage conditioning
```{r boxplots-acute-treatments-within-life-stages-conditioning, eval=TRUE}
# Loop through each comparison in the t-test results and create box plots
for (comparison in unique(acute_treatment_within_life.stages_conditioning_t_test_results_df$comparison)) {
  create_boxplot_acute_conditioning(delta_Cq_df, comparison, acute_treatment_within_life.stages_conditioning_t_test_results_df)
}
```


# Delta delta Cq

## Calculations

### Conditioning
```{r delta-delta-Cq-conditioning, eval=TRUE}
# Calculate delta_delta_Cq
delta_delta_conditioning_fold_change <- delta_Cq_df %>%
  group_by(life.stage, Target) %>%
  summarize(
    treated_delta_Cq = mean(delta_Cq[conditioning.treatment == "treated"], na.rm = TRUE),
    control_delta_Cq = mean(delta_Cq[conditioning.treatment == "control"], na.rm = TRUE)
  ) %>%
  mutate(delta_delta_Cq = treated_delta_Cq - control_delta_Cq) %>%
  select(life.stage, Target, delta_delta_Cq)

str(delta_delta_conditioning_fold_change)
```

### Acute treatment
```{r delta-delta-Cq-acute, eval=TRUE}
# Calculate delta_delta_Cq for acute treatment
delta_delta_Cq_acute_df <- delta_Cq_df %>%
  group_by(life.stage, Target, acute.treatment) %>%
  summarize(
    treated_delta_Cq = mean(delta_Cq[conditioning.treatment == "treated"], na.rm = TRUE),
    control_delta_Cq = mean(delta_Cq[conditioning.treatment == "control"], na.rm = TRUE)
  ) %>%
  mutate(delta_delta_Cq = treated_delta_Cq - control_delta_Cq) %>%
  select(life.stage, Target, acute.treatment, delta_delta_Cq)

str(delta_delta_Cq_acute_df)

```

### Life stage
```{r delta-delta-Cq-life-stage}
# Calculate delta_delta_Cq for life stage comparisons
delta_delta_Cq_life_stage_df <- delta_Cq_df %>%
  group_by(Target, life.stage) %>%
  summarize(mean_delta_Cq = mean(delta_Cq, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = life.stage, values_from = mean_delta_Cq) %>%
  mutate(
    delta_delta_Cq_adult_vs_seed = adult - seed,
    delta_delta_Cq_spat_vs_seed = spat - seed,
    delta_delta_Cq_adult_vs_spat = adult - spat
  ) %>%
  pivot_longer(cols = starts_with("delta_delta_Cq_"), names_to = "comparison", values_to = "delta_delta_Cq") %>%
  filter(!is.na(delta_delta_Cq))

# Display the structure of the resulting data frame
str(delta_delta_Cq_life_stage_df)
```

### Calculate delta delta acute treatments within lifestage and conditioning
```{r delta-delta-Cq-acute-within-life-stage-conditioning, eval=TRUE}
# Calculate delta_delta_Cq for acute treatment comparisons within each life stage and conditioning treatment
delta_delta_Cq_acute_within_life_stage_conditioning_df <- delta_Cq_df %>%
  group_by(life.stage, conditioning.treatment, Target, acute.treatment) %>%
  summarize(mean_delta_Cq = mean(delta_Cq, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = acute.treatment, values_from = mean_delta_Cq) %>%
  mutate(delta_delta_Cq_high_vs_ambient = high - ambient) %>%
  pivot_longer(cols = starts_with("delta_delta_Cq_"), names_to = "comparison", values_to = "delta_delta_Cq") %>%
  filter(!is.na(delta_delta_Cq))

# Display the structure of the resulting data frame
str(delta_delta_Cq_acute_within_life_stage_conditioning_df)
```

### Calculate the fold change life stage comparison
```{r fold-change-life-stage}
# Calculate fold change and output to a new data frame
fold_change_life_stage_df <- delta_delta_Cq_life_stage_df %>%
  mutate(fold_change = 2^(-delta_delta_Cq))

# Display the structure of the resulting data frame
str(fold_change_life_stage_df)
```

### Calculate the fold change conditioning comparison
```{r fold-change-condition, eval=TRUE}
delta_delta_conditioning_fold_change <- delta_delta_conditioning_fold_change %>%
  mutate(fold_change = 2^(-delta_delta_Cq)) %>% 
  distinct(Target, fold_change)

str(delta_delta_conditioning_fold_change)
```


### Calculate the fold change acute comparison
```{r fold-change-acute, eval=TRUE}
# Calculate fold change for acute treatment
delta_delta_acute_fold_change <- delta_delta_Cq_acute_df %>%
  mutate(fold_change = 2^(-delta_delta_Cq)) %>%
  distinct(life.stage, Target, acute.treatment, fold_change)

# Display the structure of the resulting data frame
str(delta_delta_acute_fold_change)
```

### Calculate fold change acute treatments within lifestage and conditioning
```{r fold-change-acute-within-life-stage-conditioning, eval=TRUE}
# Calculate fold change for acute treatment comparisons within each life stage and conditioning treatment
fold_change_acute_within_life_stage_conditioning_df <- delta_delta_Cq_acute_within_life_stage_conditioning_df %>%
  mutate(fold_change = 2^(-delta_delta_Cq))

# Display the structure of the resulting data frame
str(fold_change_acute_within_life_stage_conditioning_df)
```

## Plotting fold changes

### Acute comparisons within lifestage and conditioning
```{r bar-plots-fold-change-acute-within-lifestage-conditioning, eval=TRUE, warning=FALSE, message=FALSE}
library(ggplot2)

# Generate bar plots for each group of comparison within each life stage and conditioning treatment
plot_list <- fold_change_acute_within_life_stage_conditioning_df %>%
  split(list(.$life.stage, .$conditioning.treatment, .$comparison)) %>%
  lapply(function(df) {
    life_stage <- unique(df$life.stage)
    conditioning_treatment <- unique(df$conditioning.treatment)
    comparison_title <- gsub("delta_delta_Cq_", "", unique(df$comparison))
    comparison_title <- gsub("_vs_", " vs. ", comparison_title)
    ggplot(df, aes(x = Target, y = fold_change)) +
      geom_bar(stat = "identity") +
      labs(title = paste("Gene Expression -", life_stage, "-", conditioning_treatment, "-", comparison_title), 
           x = "Target", y = "Fold Change") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  })

# Display the plots
for (plot in plot_list) {
  print(plot)
}
```

### Life stage comparisons
```{r bar-plots-fold-change, eval=TRUE}

# Generate bar plots for each group of comparison
plot_list <- fold_change_life_stage_df %>%
  split(.$comparison) %>%
  lapply(function(df) {
    comparison_title <- gsub("delta_delta_Cq_", "", unique(df$comparison))
    comparison_title <- gsub("_vs_", " vs. ", comparison_title)
    ggplot(df, aes(x = Target, y = fold_change)) +
      geom_bar(stat = "identity") +
      labs(title = paste("Gene Expression -", comparison_title), x = "Target", y = "Fold Change") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  })

# Display the plots
for (plot in plot_list) {
  print(plot)
}
```

### Conditioning comparisons
```{r barplot-fold-change-conditioning, echo=FALSE, eval=TRUE}

# Create the bar plot
ggplot(delta_delta_conditioning_fold_change, aes(x = Target, y = fold_change, fill = Target)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ life.stage, scales = "free_x") +
  theme_minimal() +
  labs(title = "Fold Change in Conditioning Expression by Target and Life Stage",
       x = "Target",
       y = "Fold Change") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Line plot conditioning comparisons across lifestages
```{r lineplot-fold-change-conditioning, echo=FALSE, eval=TRUE}
# Ensure life.stage is a factor with the correct order
delta_delta_conditioning_fold_change$life.stage <- factor(delta_delta_conditioning_fold_change$life.stage,
                                                          levels = c("seed", "spat", "juvenile", "adult"))

# Create the line plot
ggplot(delta_delta_conditioning_fold_change, aes(x = life.stage, y = fold_change, color = Target, group = Target)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(title = "Fold Change in Conditioning Expression by Target and Life Stage",
       x = "Life Stage",
       y = "Fold Change") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, NA)
```

### Acute treatment comparison
```{r barplot-fold-change-acute, echo=FALSE, eval=TRUE}
# Create the bar plot
ggplot(delta_delta_acute_fold_change, aes(x = Target, y = fold_change, fill = acute.treatment)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ life.stage, scales = "free_x") +
  theme_minimal() +
  labs(title = "Fold Change in Acute Treatment Expression by Target and Life Stage",
       x = "Target",
       y = "Fold Change") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


